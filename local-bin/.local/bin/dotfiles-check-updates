#!/usr/bin/env bash

DOTFILES_DIR="$HOME/dotfiles"
BRANCH="main"

if [ ! -d "$DOTFILES_DIR" ]; then
    echo "Error: Dotfiles directory not found at $DOTFILES_DIR" >&2
    exit 1
fi

if [ ! -d "$DOTFILES_DIR/.git" ]; then
    echo "Error: $DOTFILES_DIR is not a git repository" >&2
    exit 1
fi

cd "$DOTFILES_DIR" || exit 0

# Check for uncommitted changes (modified, added, deleted files)
if ! git diff-index --quiet HEAD --; then
    echo "âš  Uncommitted changes found in dotfiles:"
    git diff-index --name-status HEAD -- | sed 's/^/  /'
fi

# Check for untracked files
UNTRACKED=$(git ls-files --others --exclude-standard)
if [ -n "$UNTRACKED" ]; then
    echo "âš  Untracked files found in dotfiles:"
    echo "$UNTRACKED" | sed 's/^/  /'
fi

git fetch origin "$BRANCH" 2>/dev/null

LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u} 2>/dev/null)

if [ -z "$REMOTE" ]; then
    echo "Error: Unable to fetch remote branch information" >&2
    exit 1
fi

if [ "$LOCAL" != "$REMOTE" ]; then
    COMMITS_BEHIND=$(git rev-list --count HEAD..@{u} 2>/dev/null)
    echo "ðŸ”” Dotfiles updates available! ($COMMITS_BEHIND commit(s) behind)"
    echo "   Run: dotfiles-update"
fi
