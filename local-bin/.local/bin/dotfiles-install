#!/usr/bin/env bash

set -euo pipefail

DOTFILES_REPO="davidwinter/dotfiles"
DOTFILES_DIR="$HOME/dotfiles"
OP_AGENT_SOCKET_PATH="$HOME/.1password/agent.sock"
OP_SSH_SIGN_PATH="/usr/local/bin/op-ssh-sign"

is_macos() {
    [ "$(uname -s)" = "Darwin" ]
}

is_linux() {
    [ "$(uname -s)" = "Linux" ]
}

is_ubuntu() {
    [ "$LINUX_DISTRO" = "ubuntu" ]
}

is_archlinux() {
    [ "$LINUX_DISTRO" = "arch" ]
}

LINUX_DISTRO=$((is_linux && source /etc/os-release && echo "$ID") || true)

ensure_installed() {
    local cmd="$1"
    local pkg="${2:-$1}"

    if command -v "$cmd" >/dev/null 2>&1; then
        return 0
    fi

    if is_macos; then
        brew install "$pkg"
    elif is_linux; then
        if is_ubuntu; then
            sudo apt update && sudo apt install -y "$pkg"
        elif is_archlinux; then
            sudo pacman -Syu "$pkg"
        fi
    fi
}


ensure_1password_agent() {
    local socket="${1:-$OP_AGENT_SOCKET_PATH}"

    if [ -S "$socket" ]; then
        return 0
    fi

    if is_macos; then
        ln -s "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock" "$socket"
        return 0
    fi

    echo "Ensure the 1Password agent is running and the socket exists at $socket (or create an appropriate symlink)."
    exit 1
}

ensure_1password_ssh_sign() {
    local target="${1:-$OP_SSH_SIGN_PATH}"

    if [ -x "$target" ]; then
        return 0
    fi

    if is_macos; then
        ln -s "/Applications/1Password.app/Contents/MacOS/op-ssh-sign" "$target"
    fi

    if is_linux; then
        ln -s "/opt/1Password/op-ssh-sign" "$target"
    fi
}

clone_repo() {
    local repo="${1:-$DOTFILES_REPO}"
    local dest="${2:-$DOTFILES_DIR}"
    local agent_socket="${3:-$OP_AGENT_SOCKET_PATH}"

    if [ -e "$dest" ]; then
        return 0
    fi

    mkdir -p "$(dirname "$dest")"

    SSH_AUTH_SOCK="$agent_socket" git clone "git@github.com:$repo.git" "$dest"
}



ensure_fish_in_etc_shells() {
    local fish_path="${1:-$(command -v fish 2>/dev/null || true)}"

    if grep -Fxq "$fish_path" /etc/shells; then
        return 0
    fi

    printf '%s\n' "$fish_path" | sudo tee -a /etc/shells
}

ensure_fish_is_default_shell() {
    local fish_path="${1:-$(command -v fish 2>/dev/null || true)}"
    local current_shell="${SHELL:-$(getent passwd "$(whoami)" 2>/dev/null | cut -d: -f7 || true)}"

    if [ "$current_shell" = "$fish_path" ]; then
        return 0
    fi

    chsh -s "$fish_path"
}

stow_package() {
    local package="$1"
    stow --dir="$DOTFILES_DIR" --target="$HOME" "$package"  # && echo "✅ $package config enabled"
}

echo
echo "Packages:"
echo

PACKAGES=(git stow fish starship lazygit lazydocker mise)

for pkg in "${PACKAGES[@]}"; do
    ensure_installed "$pkg" && echo "✅ $pkg is installed"
done

echo
echo "1Password:"
echo

ensure_1password_agent "$OP_AGENT_SOCKET_PATH" && echo "✅ 1Password agent socket OK"
ensure_1password_ssh_sign "$OP_SSH_SIGN_PATH" && echo "✅ 1Password op-ssh-sign helper available at $OP_SSH_SIGN_PATH"

echo
echo "Dotfiles repo:"
echo

clone_repo && echo "✅ dotfiles repository available at $DOTFILES_DIR"

echo
echo "Fish shell:"
echo

ensure_fish_in_etc_shells && echo "✅ fish is listed in /etc/shells"
ensure_fish_is_default_shell && echo "✅ fish is your default login shell"

echo
echo "Dotfile configs:"
echo

STOW_PACKAGES=(local-bin ssh git fish starship hushlogin)
for pkg in "${STOW_PACKAGES[@]}"; do
    stow_package "$pkg" && echo "✅ $pkg config enabled"
done

is_macos && stow_package ghostty-macOS && echo "✅ ghostty-macOS config enabled"
