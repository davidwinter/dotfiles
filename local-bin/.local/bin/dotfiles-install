#!/usr/bin/env bash

set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
OP_AGENT_SOCKET_PATH="$HOME/.1password/agent.sock"
OP_SSH_SIGN_PATH="/usr/local/bin/op-ssh-sign"

# Ensure helper scripts are in PATH (in case run directly, not from bootstrap)
if ! dotfiles-has-command dotfiles-has-command 2>/dev/null; then
    export PATH="$DOTFILES_DIR/local-bin/.local/bin:$PATH"
fi

elevate_priv() {
    if ! dotfiles-has-command sudo; then
        echo "sudo not found" >&2
        exit 1
    fi

    if ! sudo -v; then
        echo "Superuser not granted, aborting installation" >&2
        exit 1
    fi
}

ensure_installed() {
    if dotfiles-is-macos; then
        if brew list "$@" &>/dev/null || dotfiles-has-command "$@"; then
            return 0
        fi

        brew install "$@"
    elif dotfiles-is-linux; then
        elevate_priv

        if dotfiles-is-ubuntu; then
            if dpkg -s "$@" &>/dev/null || dotfiles-has-command "$@"; then
                return 0
            fi

            sudo apt update && sudo apt install -y "$@"
        elif dotfiles-is-archlinux; then
            if pacman -Q "$@" &>/dev/null || dotfiles-has-command "$@"; then
                return 0
            fi

            sudo pacman -Syu "$@"
        fi
    fi
}

ensure_1password_agent() {
    local socket="${1:-$OP_AGENT_SOCKET_PATH}"

    if [[ -S "$socket" ]]; then
        return 0
    fi

    if dotfiles-is-macos; then
        ln -s "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock" "$socket"
        return 0
    fi

    echo "Ensure the 1Password agent is running and the socket exists at $socket (or create an appropriate symlink)."
    exit 1
}

ensure_1password_ssh_sign() {
    local target="${1:-$OP_SSH_SIGN_PATH}"

    if [[ -x "$target" ]]; then
        return 0
    fi

    elevate_priv

    if dotfiles-is-macos; then
        sudo ln -s "/Applications/1Password.app/Contents/MacOS/op-ssh-sign" "$target"
    fi

    if dotfiles-is-linux; then
        if dotfiles-is-wsl; then
            local win_home=$(wslpath "$(cmd.exe /c 'echo %USERPROFILE%' 2>/dev/null | tr -d '\r')")
            sudo ln -s "$win_home/AppData/Local/1Password/app/8/op-ssh-sign-wsl" "$target"
        else
            sudo ln -s "/opt/1Password/op-ssh-sign" "$target"
        fi
    fi
}

ensure_git_remote_ssh() {
    cd "$DOTFILES_DIR"

    local current_remote=$(git remote get-url origin)

    if [[ "$current_remote" =~ ^git@github\.com: ]]; then
        echo "   âœ… Git remote already uses SSH"
        return 0
    fi

    if [[ "$current_remote" =~ ^https://github\.com/(.+)$ ]]; then
        local repo="${BASH_REMATCH[1]}"
        repo="${repo%.git}"
        local ssh_url="git@github.com:${repo}.git"

        git remote set-url origin "$ssh_url"
        echo "   âœ… Switched git remote from HTTPS to SSH"
    fi
}

ensure_fish_in_etc_shells() {
    local fish_path="${1:-$(command -v fish 2>/dev/null || true)}"

    if grep -Fxq "$fish_path" /etc/shells; then
        return 0
    fi

    elevate_priv

    printf '%s\n' "$fish_path" | sudo tee -a /etc/shells
}

ensure_fish_is_default_shell() {
    local fish_path="${1:-$(command -v fish 2>/dev/null || true)}"
    local current_shell="${SHELL:-$(getent passwd "$(whoami)" 2>/dev/null | cut -d: -f7 || true)}"

    if [[ "$current_shell" == "$fish_path" ]]; then
        return 0
    fi

    chsh -s "$fish_path"
}

stow_package() {
    local package="$1"
    stow --dir="$DOTFILES_DIR" --target="$HOME" "$package"
}

echo
echo "ğŸ“¦ Packages:"
echo

PACKAGES=(git stow fish starship lazygit lazydocker mise eza)

for pkg in "${PACKAGES[@]}"; do
    if ensure_installed "$pkg"; then
        echo "   âœ… $pkg is installed"
    else
        echo "   âš ï¸  Failed to install $pkg - please install it manually" >&2
        exit 1
    fi
done

dotfiles-is-macos && ensure_installed --cask font-jetbrains-mono-nerd-font && echo "   âœ… JetBrains Mono Nerd Font installed"
dotfiles-is-archlinux && ensure_installed ttf-jetbrains-mono-nerd && echo "   âœ… JetBrains Mono Nerd Font installed"

echo
echo "ğŸ”‘ 1Password:"
echo

if ! dotfiles-is-wsl; then
    ensure_1password_agent "$OP_AGENT_SOCKET_PATH" && echo "   âœ… 1Password agent socket OK"
fi

ensure_1password_ssh_sign "$OP_SSH_SIGN_PATH" && echo "   âœ… 1Password op-ssh-sign helper available at $OP_SSH_SIGN_PATH"

echo
echo "ğŸ” Git Remote:"
echo

ensure_git_remote_ssh

echo
echo "ğŸ“ƒ Dotfile configs:"
echo

STOW_PACKAGES=(local-bin ssh git fish starship hushlogin)
for pkg in "${STOW_PACKAGES[@]}"; do
    (stow_package "$pkg" && echo "   âœ… $pkg config enabled") || echo "   âŒ $pkg config failed"
done

dotfiles-is-archlinux && stow_package omarchy && echo "   âœ… omarchy config enabled"
dotfiles-is-macos && stow_package ghostty-macOS && echo "   âœ… ghostty-macOS config enabled"
dotfiles-is-wsl && stow_package git-wsl && echo "   âœ… git-wsl config enabled"

echo
echo "ğŸŸ Fish shell:"
echo

ensure_fish_in_etc_shells && echo "   âœ… fish is listed in /etc/shells"
(ensure_fish_is_default_shell && echo "   âœ… fish is your default login shell") || echo "   âŒ Run the following to change shell:    chsh -s \"$(command -v fish)\""

echo
