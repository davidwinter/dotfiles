#!/usr/bin/env bash

set -euo pipefail

DOTFILES_REPO="davidwinter/dotfiles"
DOTFILES_DIR="$HOME/dotfiles"
OP_AGENT_SOCKET_PATH="$HOME/.1password/agent.sock"
OP_SSH_SIGN_PATH="/usr/local/bin/op-ssh-sign"

is_macos() {
    [ "$(uname -s)" = "Darwin" ]
}

is_linux() {
    [ "$(uname -s)" = "Linux" ]
}

is_ubuntu() {
    [ "$LINUX_DISTRO" = "ubuntu" ]
}

is_archlinux() {
    [ "$LINUX_DISTRO" = "arch" ]
}

is_wsl() {
    grep -qi microsoft /proc/version 2>/dev/null
}

LINUX_DISTRO=$((is_linux && source /etc/os-release && echo "$ID") || true)

has() {
  command -v "$1" 1>/dev/null 2>&1
}

elevate_priv() {
    if ! has sudo; then
        echo "sudo not found" >&2
        exit 1
    fi

    if ! sudo -v; then
        echo "Superuser not granted, aborting installation" >&2
        exit 1
    fi
}

ensure_installed() {
    local cmd="$1"
    local pkg="${2:-$1}"

    if has "$cmd"; then
        return 0
    fi

    if is_macos; then
        if ! brew install "$pkg"; then
            return 1
        fi
    elif is_linux; then
        elevate_priv

        if is_ubuntu; then
            if ! sudo apt update || ! sudo apt install -y "$pkg"; then
                return 1
            fi
        elif is_archlinux; then
            if ! sudo pacman -Syu "$pkg"; then
                return 1
            fi
        fi
    fi
}

ensure_1password_agent() {
    local socket="${1:-$OP_AGENT_SOCKET_PATH}"

    if [ -S "$socket" ]; then
        return 0
    fi

    if is_macos; then
        ln -s "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock" "$socket"
        return 0
    fi

    echo "Ensure the 1Password agent is running and the socket exists at $socket (or create an appropriate symlink)."
    exit 1
}

ensure_1password_ssh_sign() {
    local target="${1:-$OP_SSH_SIGN_PATH}"

    if [ -x "$target" ]; then
        return 0
    fi

    elevate_priv

    if is_macos; then
        sudo ln -s "/Applications/1Password.app/Contents/MacOS/op-ssh-sign" "$target"
    fi

    if is_linux; then
        if is_wsl; then
            sudo ln -s "/mnt/c/Users/DavidWinter/AppData/Local/1Password/app/8/op-ssh-sign-wsl" "$target"
        else
            sudo ln -s "/opt/1Password/op-ssh-sign" "$target"
        fi
    fi
}

clone_repo() {
    local repo="${1:-$DOTFILES_REPO}"
    local dest="${2:-$DOTFILES_DIR}"
    local agent_socket="${3:-$OP_AGENT_SOCKET_PATH}"

    if [ -e "$dest" ]; then
        return 0
    fi

    mkdir -p "$(dirname "$dest")"

    if is_wsl; then
        GIT_SSH_COMMAND="ssh.exe" git clone "git@github.com:$repo.git" "$dest"
    else
        SSH_AUTH_SOCK="$agent_socket" git clone "git@github.com:$repo.git" "$dest"
    fi
}

ensure_fish_in_etc_shells() {
    local fish_path="${1:-$(command -v fish 2>/dev/null || true)}"

    if grep -Fxq "$fish_path" /etc/shells; then
        return 0
    fi

    elevate_priv

    printf '%s\n' "$fish_path" | sudo tee -a /etc/shells
}

ensure_fish_is_default_shell() {
    local fish_path="${1:-$(command -v fish 2>/dev/null || true)}"
    local current_shell="${SHELL:-$(getent passwd "$(whoami)" 2>/dev/null | cut -d: -f7 || true)}"

    if [ "$current_shell" = "$fish_path" ]; then
        return 0
    fi

    chsh -s "$fish_path"
}

stow_package() {
    local package="$1"
    stow --dir="$DOTFILES_DIR" --target="$HOME" "$package"  # && echo "âœ… $package config enabled"
}

echo
echo "ğŸ“¦ Packages:"
echo

PACKAGES=(git stow fish starship lazygit lazydocker mise)

for pkg in "${PACKAGES[@]}"; do
    if ensure_installed "$pkg"; then
        echo "   âœ… $pkg is installed"
    else
        echo "   âš ï¸  Failed to install $pkg - please install it manually" >&2
        exit 1
    fi
done

echo
echo "ğŸ”‘ 1Password:"
echo

if ! is_wsl; then
    ensure_1password_agent "$OP_AGENT_SOCKET_PATH" && echo "   âœ… 1Password agent socket OK"
fi

ensure_1password_ssh_sign "$OP_SSH_SIGN_PATH" && echo "   âœ… 1Password op-ssh-sign helper available at $OP_SSH_SIGN_PATH"

echo
echo "ğŸ”¨ Dotfiles repo:"
echo

clone_repo && echo "   âœ… dotfiles repository available at $DOTFILES_DIR"

echo
echo "ğŸ“ƒ Dotfile configs:"
echo

STOW_PACKAGES=(local-bin ssh git fish starship hushlogin)
for pkg in "${STOW_PACKAGES[@]}"; do
    (stow_package "$pkg" && echo "   âœ… $pkg config enabled") || echo "   âŒ $pkg config failed"
done

is_macos && stow_package ghostty-macOS && echo "   âœ… ghostty-macOS config enabled"

echo
echo "ğŸŸ Fish shell:"
echo

ensure_fish_in_etc_shells && echo "   âœ… fish is listed in /etc/shells"
(ensure_fish_is_default_shell && echo "   âœ… fish is your default login shell") || echo "   âŒ Run the following to change shell:    chsh -s \"$fish_path\""

echo
