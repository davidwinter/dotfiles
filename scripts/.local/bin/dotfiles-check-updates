#!/usr/bin/env bash
set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"

cd "$DOTFILES_DIR"

if ! git diff-index --quiet HEAD --; then
    echo "âš  Uncommitted changes found in dotfiles:"
    git diff-index --name-status HEAD -- | sed 's/^/  /'
fi

UNTRACKED=$(git ls-files --others --exclude-standard)
if [[ -n "$UNTRACKED" ]]; then
    echo "âš  Untracked files found in dotfiles:"
    echo "$UNTRACKED" | sed 's/^/  /'
fi

if ! git fetch origin 2>/dev/null; then
    echo "Error: Unable to fetch from remote repository" >&2
    exit 1
fi

LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u} 2>/dev/null)

if [[ -z "$REMOTE" ]]; then
    echo "Error: Unable to fetch remote branch information" >&2
    exit 1
fi

if [[ "$LOCAL" != "$REMOTE" ]]; then
    COMMITS_BEHIND=$(git rev-list --count HEAD..@{u} 2>/dev/null)
    echo "ðŸ”” Dotfiles updates available! ($COMMITS_BEHIND commit(s) behind)"
    echo "   Run: dotfiles-update"
fi
