#!/usr/bin/env bash
# Check dotfiles health and report status

set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"

# Ensure helper scripts are in PATH
if ! dotfiles-has-command dotfiles-has-command 2>/dev/null; then
    export PATH="$DOTFILES_DIR/scripts/.local/bin:$PATH"
fi

# Source shared library
source "$DOTFILES_DIR/scripts/.local/lib/dotfiles-lib.sh"

echo "ğŸ¥ Dotfiles Health Check"
echo

# Packages
echo "ğŸ“¦ Packages:"
PACKAGES=(git stow fish starship lazygit lazydocker mise eza)
for pkg in "${PACKAGES[@]}"; do
    if check_package_installed "$pkg"; then
        echo "   âœ… $pkg"
    else
        echo "   âŒ $pkg"
    fi
done

# Platform-specific packages
if dotfiles-is-macos; then
    if check_package_installed "font-jetbrains-mono-nerd-font"; then
        echo "   âœ… JetBrains Mono Nerd Font"
    else
        echo "   âŒ JetBrains Mono Nerd Font"
    fi
fi

if dotfiles-is-archlinux; then
    if check_package_installed "ttf-jetbrains-mono-nerd"; then
        echo "   âœ… JetBrains Mono Nerd Font"
    else
        echo "   âŒ JetBrains Mono Nerd Font"
    fi
fi

# 1Password
echo
echo "ğŸ”‘ 1Password:"
if check_1password_agent; then
    echo "   âœ… Agent socket"
else
    echo "   âŒ Agent socket"
fi

if check_1password_ssh_sign; then
    echo "   âœ… SSH sign helper"
else
    echo "   âŒ SSH sign helper"
fi

# Git
echo
echo "ğŸ” Git:"
if check_git_remote_ssh; then
    echo "   âœ… Remote uses SSH"
else
    echo "   âŒ Remote uses HTTPS"
fi

# Configurations
echo
echo "ğŸ“ƒ Configurations:"

if check_dotfiles_config_present "scripts" "."; then
    echo "   âœ… scripts"
else
    echo "   âŒ scripts"
fi

CONFIG_PACKAGES=(ssh git fish starship hushlogin)
for pkg in "${CONFIG_PACKAGES[@]}"; do
    if check_dotfiles_config_present "$pkg"; then
        echo "   âœ… $pkg"
    else
        echo "   âŒ $pkg"
    fi
done

# Platform-specific configs
if dotfiles-is-archlinux; then
    if check_dotfiles_config_present "omarchy"; then
        echo "   âœ… omarchy"
    else
        echo "   âŒ omarchy"
    fi
fi

if dotfiles-is-macos; then
    if check_dotfiles_config_present "ghostty-macOS"; then
        echo "   âœ… ghostty-macOS"
    else
        echo "   âŒ ghostty-macOS"
    fi
fi

if dotfiles-is-wsl; then
    if check_dotfiles_config_present "git-wsl"; then
        echo "   âœ… git-wsl"
    else
        echo "   âŒ git-wsl"
    fi
fi

# Fish shell
echo
echo "ğŸŸ Fish Shell:"
if check_fish_in_etc_shells; then
    echo "   âœ… Listed in /etc/shells"
else
    echo "   âŒ Not in /etc/shells"
fi

if check_fish_is_default_shell; then
    echo "   âœ… Default shell"
else
    echo "   âŒ Not default shell"
fi

# Migrations
echo
echo "ğŸ“‹ Migrations:"
if check_migrations_applied; then
    echo "   âœ… All applied"
else
    echo "   âš ï¸  Pending (run: dotfiles-update)"
fi

echo
echo "ğŸ’¡ To fix issues, run: dotfiles-install"
