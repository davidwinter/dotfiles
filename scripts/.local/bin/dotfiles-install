#!/usr/bin/env bash

set -euo pipefail

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
OP_AGENT_SOCKET_PATH="$HOME/.1password/agent.sock"
OP_SSH_SIGN_PATH="/usr/local/bin/op-ssh-sign"

# Ensure helper scripts are in PATH (in case run directly, not from bootstrap)
if ! dotfiles-has-command dotfiles-has-command 2>/dev/null; then
    export PATH="$DOTFILES_DIR/scripts/.local/bin:$PATH"
fi

# Source shared library
source "$DOTFILES_DIR/scripts/.local/lib/dotfiles-lib.sh"

mark_migrations_as_applied() {
    local state_dir="${XDG_STATE_HOME:-$HOME/.local/state}/dotfiles/migrations"

    # Only mark migrations on fresh install (state directory doesn't exist yet)
    if [[ -d "$state_dir" ]]; then
        echo "   â„¹ï¸  Skipping (existing installation)"
        return 0
    fi

    mkdir -p "$state_dir"

    if [[ -d "$DOTFILES_DIR/migrations" ]]; then
        for migration in "$DOTFILES_DIR/migrations"/*.sh; do
            [[ -f "$migration" ]] || continue
            local migration_file=$(basename "$migration")
            touch "$state_dir/$migration_file"
            echo "   âœ… Marked $migration_file as applied"
        done
    fi
}

echo
echo "ğŸ“¦ Packages:"
echo

PACKAGES=(git stow fish starship lazygit lazydocker mise eza)

for pkg in "${PACKAGES[@]}"; do
    if ensure_package_installed "$pkg"; then
        echo "   âœ… $pkg is installed"
    else
        echo "   âš ï¸  Failed to install $pkg - please install it manually" >&2
        exit 1
    fi
done

dotfiles-is-macos && ensure_package_installed font-jetbrains-mono-nerd-font && echo "   âœ… JetBrains Mono Nerd Font installed"
dotfiles-is-archlinux && ensure_package_installed ttf-jetbrains-mono-nerd && echo "   âœ… JetBrains Mono Nerd Font installed"

echo
echo "ğŸ”‘ 1Password:"
echo

if ! dotfiles-is-wsl; then
    ensure_1password_agent "$OP_AGENT_SOCKET_PATH" && echo "   âœ… 1Password agent socket OK"
fi

ensure_1password_ssh_sign "$OP_SSH_SIGN_PATH" && echo "   âœ… 1Password op-ssh-sign helper available at $OP_SSH_SIGN_PATH"

echo
echo "ğŸ” Git Remote:"
echo

if ensure_git_remote_ssh; then
    echo "   âœ… Git remote configured for SSH"
fi

echo
echo "ğŸ“ƒ Dotfile configs:"
echo

(ensure_dotfiles_config_present "scripts" "." && echo "   âœ… scripts config enabled") || echo "   âŒ scripts config failed"

STOW_PACKAGES=(ssh git fish starship hushlogin)
for pkg in "${STOW_PACKAGES[@]}"; do
    (ensure_dotfiles_config_present "$pkg" && echo "   âœ… $pkg config enabled") || echo "   âŒ $pkg config failed"
done

dotfiles-is-archlinux && ensure_dotfiles_config_present "omarchy" && echo "   âœ… omarchy config enabled"
dotfiles-is-macos && ensure_dotfiles_config_present "ghostty-macOS" && echo "   âœ… ghostty-macOS config enabled"
dotfiles-is-wsl && ensure_dotfiles_config_present "git-wsl" && echo "   âœ… git-wsl config enabled"

echo
echo "ğŸŸ Fish shell:"
echo

ensure_fish_in_etc_shells && echo "   âœ… fish is listed in /etc/shells"
(ensure_fish_is_default_shell && echo "   âœ… fish is your default login shell") || echo "   âŒ Run the following to change shell:    chsh -s \"$(command -v fish)\""

echo
echo "ğŸ“‹ Migrations:"
echo

mark_migrations_as_applied

echo
